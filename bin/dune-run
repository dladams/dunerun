#!/bin/bash
#
# dune-run
# David Adams
# February 2022
#
# A script to run  a command in a dunesw enviroment.

ENV=$DUNESW_SUPPORT_ENV
REL=${DUNESW_SUPPORT_RELEASE:-v09_42_04_00}
LEVEL=0
while [[ $# -gt 0 ]]; do
  ARG=$1
  if [ "$ARG" = "-h" ]; then
    echo "Usage: $0 [-e ENV] [-r REL] [-d LEVEL] COM"
    echo "Runs command COM in the environment defined by \"source setup-ENV.sh REL\""
    echo "  ENV - Environment name."
    echo "        Default is env variable DUNESW_SUPPORT_ENV."
    echo "        Provided here:"
    echo "          dune - Sets up dune w/o any packages."
    echo "          dunesw - Sets up dune w/ dunesw with REL=VERS:QUAL"
    echo "        If udefined or '.', the command is run without setup."
    echo "  REL - Release tag (e.g. v09_42_03_00 or v09_42_03_00:c7:prof)"
    echo "        Default is env variable DUNESW_SUPPORT_RELEASE."
    echo "  LEVEL - 0 - Command is executed with no output from this script or"
    echo "              from the setup (default)"
    echo "          1 - Command is executed with informational messages."
    echo "          2 - Command and infomational messages are displayed w/o execution."
    echo "If both setup and release are provided then the release is"
    echo "passed as an argument to the setup."
    echo "If only the setup is provided then the release is set up from CVMFS"
    echo "Command 'shell' starts an interactive bash shell in the environment."
    exit 0
  elif [ "$ARG" = "-r" ]; then
    shift
    REL=$1
    shift
  elif [ "$ARG" = "-e" ]; then
    shift
    ENV=$1
    shift
  elif [ "$ARG" = "-d" ]; then
    shift
    LEVEL=${1:-0}
    shift
  else
    COM="$@"
    break
  fi
done

MYNAME="dune-run: "
if [ $LEVEL -gt 0 ]; then
  echo "$MYNAME ENV: $ENV"
  echo "$MYNAME REL: $REL"
  echo "$MYNAME COM: $@"
fi


if [ "$COM" = shell ]; then
  if [ $LEVEL -gt 0 ]; then
    echo "$MYNAME Starting shell..."
  fi
  NEWPS1=$ENV
  if [ -n "$REL" ]; then
    NEWPS1=$NEWPS1-$REL
  fi
  NEWPS1=${NEWPS1}'> '
  if [ $LEVEL -gt 0 ]; then
    echo "$MYNAME Setting prompt $NEWPS1"
  fi
  bash --rcfile <(echo 'source dune-run -e '$ENV' -r '$REL'; export PS1="'$NEWPS1'"')

else

  if [ -n "$ENV" -a "$ENV" != "." ]; then
    SETUP_FILE=setup-$ENV.sh
    if [ $LEVEL -gt 0 ]; then echo $MYNAME Setting up.; fi
    if [ $LEVEL -eq 2 ]; then
       echo $MYNAME '>' source $SETUP_FILE $REL 2>&1 1>/dev/null
    elif [ $LEVEL -eq 0 ]; then
       source $SETUP_FILE $REL 2>&1 1>/dev/null
    else
      source $SETUP_FILE $REL
    fi
  fi

  if [ $# -gt 0 ]; then
    if [ $LEVEL -gt 0 ]; then echo $MYNAME Executing.; fi
    if [ $LEVEL -eq 2 ]; then
      echo $MYNAME '>' $@
    else
      if [ ${#@} > 0 ]; then
        $@
      fi
    fi
  fi

fi
